name: trend-insight

services:
  kafka:
    image: confluentinc/cp-kafka:7.6.1
    container_name: trend-kafka
    ports:
      - "9092:9092"
    environment:
      - KAFKA_PROCESS_ROLES=broker,controller
      - KAFKA_CLUSTER_ID=MkU3OEVBNTcwNTJENDM2Qk
      - CLUSTER_ID=MkU3OEVBNTcwNTJENDM2Qk
      - KAFKA_NODE_ID=1
      - KAFKA_CONTROLLER_QUORUM_VOTERS=1@kafka:9093
      - KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
      - KAFKA_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_AUTO_CREATE_TOPICS_ENABLE=true
      - KAFKA_NUM_PARTITIONS=3
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
      - KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS=0

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: trend-kafka-ui
    depends_on:
      - kafka
    ports:
      - "8085:8080"
    environment:
      - KAFKA_CLUSTERS_0_NAME=local
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka:9092

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.13.4
    container_name: trend-elasticsearch
    hostname: trend-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms256m -Xmx256m
    ports:
      - "9200:9200"
    volumes:
      - es_data:/usr/share/elasticsearch/data

  kibana:
    image: docker.elastic.co/kibana/kibana:8.13.4
    container_name: trend-kibana
    depends_on:
      - elasticsearch
    environment:
      - ELASTICSEARCH_HOSTS=http://trend-elasticsearch:9200
    ports:
      - "5601:5601"

  logstash:
    image: docker.elastic.co/logstash/logstash:8.13.4
    container_name: trend-logstash
    depends_on:
      - kafka
      - elasticsearch
    environment:
      - LS_JAVA_OPTS=-Xms256m -Xmx256m
    volumes:
      - ./logstash/pipelines.yml:/usr/share/logstash/config/pipelines.yml:ro
      - ./logstash/pipeline:/usr/share/logstash/pipeline:ro
    ports:
      - "5044:5044"

  spark-master:
    image: apache/spark:3.5.0
    container_name: trend-spark-master
    ports:
      - "7077:7077"
      - "8080:8080"
    command:
      [
        "/opt/spark/bin/spark-class",
        "org.apache.spark.deploy.master.Master",
        "--host",
        "spark-master",
        "--port",
        "7077",
        "--webui-port",
        "8080",
      ]
    volumes:
      - ./spark:/opt/spark-apps

  spark-worker:
    image: apache/spark:3.5.0
    container_name: trend-spark-worker
    depends_on:
      - spark-master
    ports:
      - "8081:8081"
    user: root
    environment:
      - API_TOPICS_URL=http://trend-api:8000/topics
    volumes:
      - ./spark:/opt/spark-apps
      - spark_checkpoint:/checkpoints
      - api_data:/data:ro
    command:
      - /bin/bash
      - -lc
      - >
        pip install requests textblob &&
        /opt/spark/bin/spark-class org.apache.spark.deploy.worker.Worker spark://spark-master:7077 --webui-port 8081

  spark-driver:
    image: apache/spark:3.5.0
    container_name: trend-spark-driver
    depends_on:
      - kafka
      - spark-master
    user: root
    environment:
      - API_TOPICS_URL=http://trend-api:8000/topics
    volumes:
      - ./spark:/opt/spark-apps
      - spark_checkpoint:/checkpoints
      - api_data:/data:ro
    command:
      - /bin/bash
      - -lc
      - >
        pip install requests textblob &&
        python3 -m textblob.download_corpora &&
        mkdir -p /tmp/ivy &&
        /opt/spark/bin/spark-submit
        --master spark://spark-master:7077
        --conf spark.jars.ivy=/tmp/ivy
        --packages org.apache.spark:spark-sql-kafka-0-10_2.12:3.5.1
        /opt/spark-apps/sentiment_streaming.py
    restart: unless-stopped

  ingestion:
    build:
      context: ./ingestion
    container_name: trend-ingestion
    depends_on:
      - kafka
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - REDDIT_POLL_INTERVAL_SECONDS=120
      - REDDIT_LIMIT=50000
    restart: unless-stopped

  mysql:
    image: mysql:8.0
    container_name: trend-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql

  api:
    build:
      context: ./api
    container_name: trend-api
    hostname: trend-api
    depends_on:
      - elasticsearch
      - mysql
    environment:
      - ELASTICSEARCH_URL=http://trend-elasticsearch:9200
      - MYSQL_HOST=${MYSQL_HOST}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - BASIC_AUTH_USER=${BASIC_AUTH_USER}
      - BASIC_AUTH_PASS=${BASIC_AUTH_PASS}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - REDDIT_SUBREDDITS=${REDDIT_SUBREDDITS}
    ports:
      - "8000:8000"
    volumes:
      - api_data:/data

volumes:
  es_data:
  api_data:
  spark_checkpoint:
  mysql_data:
