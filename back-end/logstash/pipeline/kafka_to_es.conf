input {
  kafka {
    bootstrap_servers => "kafka:9092"
    topics => [
      "reddit.topic.metrics",
      "reddit.topic.trends",
      "reddit.topic.sentiment",
      "reddit.topic.matched",
      "reddit.topic.matched.v2",
      "reddit.topic.matches.v2" 
    ]
    codec => json
    group_id => "logstash-es-sink-v2"
    auto_offset_reset => "earliest"
  }
}

filter {
  if [timestamp] {
    date {
      match => [ "timestamp", "ISO8601" ]
      target => "@timestamp"
    }
  } else if [created_utc] {
    date {
      match => [ "created_utc", "ISO8601", "UNIX" ]
      target => "@timestamp"
    }
  }
}

output {
  if [event_type] == "matched_post" {
     # Granular Posts (Upsert Mode)
     elasticsearch {
       hosts => ["http://trend-elasticsearch:9200"]
       index => "reddit-topic-granular"
       document_id => "%{topic_id}_%{event_id}"
       action => "update"
       doc_as_upsert => true
     }
  } else if [topic_id] {
    if [event_type] {
       # Legacy Matched events
       elasticsearch {
        hosts => ["http://trend-elasticsearch:9200"]
         index => "reddit-topic-matched"
       }
    } else {
       # Metrics (Legacy)
       elasticsearch {
        hosts => ["http://trend-elasticsearch:9200"]
         index => "reddit-topic-metrics"
       }
    }
  }
  stdout { codec => rubydebug }
}

