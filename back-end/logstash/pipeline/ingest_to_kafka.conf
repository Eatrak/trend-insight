input {
  http_poller {
    urls => {
      reddit_posts_new => {
        method => get
        url => "https://www.reddit.com/r/all/new.json?limit=50"
        headers => { "User-Agent" => "trend-insight/0.1 (university project)" }
      }
      reddit_comments_new => {
        method => get
        url => "https://www.reddit.com/r/all/comments.json?limit=50"
        headers => { "User-Agent" => "trend-insight/0.1 (university project)" }
      }
    }
    request_timeout => 20
    schedule => { every => "15s" }
    codec => "json"
    metadata_target => "http_poller_metadata"
  }
}

filter {
  # Each poll returns: { kind: "Listing", data: { children: [...] } }
  if [data][children] {
    split { field => "[data][children]" }
    mutate { add_field => { "raw_kind" => "%{[data][children][kind]}" } }
    mutate { rename => { "[data][children][data]" => "[reddit]" } }
  } else {
    drop { }
  }

  if [raw_kind] == "t3" {
    mutate {
      add_field => {
        "type" => "post"
        "id" => "%{[reddit][name]}"
        "subreddit" => "%{[reddit][subreddit]}"
        "author" => "%{[reddit][author]}"
        "created_utc" => "%{[reddit][created_utc]}"
        "score" => "%{[reddit][score]}"
        "permalink" => "%{[reddit][permalink]}"
        "url" => "%{[reddit][url]}"
      }
    }
    mutate { add_field => { "text" => "%{[reddit][title]}\n%{[reddit][selftext]}" } }
  } else if [raw_kind] == "t1" {
    mutate {
      add_field => {
        "type" => "comment"
        "id" => "%{[reddit][name]}"
        "subreddit" => "%{[reddit][subreddit]}"
        "author" => "%{[reddit][author]}"
        "created_utc" => "%{[reddit][created_utc]}"
        "score" => "%{[reddit][score]}"
        "permalink" => "%{[reddit][permalink]}"
        "link_id" => "%{[reddit][link_id]}"
        "text" => "%{[reddit][body]}"
      }
    }
  } else {
    drop { }
  }

  # Convert created_utc (epoch seconds) to ISO8601 string for Spark windowing
  date {
    match => [ "created_utc", "UNIX" ]
    target => "@timestamp"
  }
  mutate {
    add_field => { "created_utc" => "%{@timestamp}" }
    convert => { "score" => "integer" }
  }

  # Keep only the schema fields we want to publish
  prune {
    whitelist_names => [
      "^id$",
      "^subreddit$",
      "^author$",
      "^created_utc$",
      "^score$",
      "^text$",
      "^type$",
      "^permalink$",
      "^url$",
      "^link_id$"
    ]
  }
}

output {
  if [type] == "post" {
    kafka {
      bootstrap_servers => "kafka:9092"
      topic_id => "reddit.posts.raw"
      codec => json
    }
  } else if [type] == "comment" {
    kafka {
      bootstrap_servers => "kafka:9092"
      topic_id => "reddit.comments.raw"
      codec => json
    }
  }
}

